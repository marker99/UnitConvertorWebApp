@page "/list"
@using UnitConvertorWebApp.Models
@using UnitConvertorWebApp.Pages.Components
@using UnitConvertorWebApp.Services
@using UnitsNet
@inject IConversionService ConversionService
@inject IFavoritesService FavoritesService

<MudTextField Class="mb-4" @bind-Value="searchText" Label="Search Quantities" Variant="Variant.Filled"
              Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" AdornmentColor="Color.Primary"
              Clearable="true" DebounceInterval="300" OnDebounceIntervalElapsed="FilterQuantities" />

@if (filteredQuantities != null)
{
    <MudItem Class="mb-2">
        <Virtualize Items="filteredQuantities" Context="quantity">
            @if (quantityData.ContainsKey(quantity))
            {
                var data = quantityData[quantity];
                <ConversionComponent TitleOfCard="@quantity"
                                     Units="@data.Units"
                                     DefaultFromUnit="@data.DefaultFromUnit"
                                     DefaultToUnit="@data.DefaultToUnit"
                                     IsFavorite="@favorites.Contains(quantity, StringComparer.OrdinalIgnoreCase)"
                                     OnToggleFavorite="@(async () => await ToggleFavoriteAsync(quantity))"
                                     Convert="@( (value, fromUnit, toUnit) => ConvertValueAsync(quantity, value, fromUnit, toUnit))" />
            }
            else
            {
                <MudProgressCircular Color="Color.Default" Indeterminate="true" />
            }
        </Virtualize>
    </MudItem>
}

@code {
    private List<string> quantities = new();
    private List<string> filteredQuantities = new();
    private List<string> favorites = new();
    private string searchText = string.Empty;
    private Dictionary<string, QuantityData> quantityData = new();

    private class QuantityData
    {
        public List<string> Units { get; set; } = new();
        public string DefaultFromUnit { get; set; } = string.Empty;
        public string DefaultToUnit { get; set; } = string.Empty;
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadFavoritesAsync();
        await LoadQuantitiesAsync();
    }

    private async Task LoadQuantitiesAsync()
    {
        quantities = await ConversionService.GetAvailableQuantitiesAsync();
        await FilterQuantities();
    }

    private async Task LoadFavoritesAsync()
    {
        favorites = await FavoritesService.GetFavoritesAsync();
    }

    private async Task LoadQuantityDataAsync(IEnumerable<string> quantitiesToLoad)
    {
        foreach (var quantity in quantitiesToLoad)
        {
            if (!quantityData.ContainsKey(quantity))
            {
                var units = await ConversionService.GetAvailableUnitsAsync(quantity);
                quantityData[quantity] = new QuantityData
                    {
                        Units = units,
                        DefaultFromUnit = units.FirstOrDefault() ?? string.Empty,
                        DefaultToUnit = units.Skip(1).FirstOrDefault() ?? string.Empty
                    };
            }
        }
    }

    private async Task FilterQuantities()
    {
        if (quantities == null) quantities = new List<string>();
        if (favorites == null) favorites = new List<string>();

        IEnumerable<string> filtered = string.IsNullOrWhiteSpace(searchText)
            ? quantities
            : quantities.Where(q => q.Contains(searchText, StringComparison.OrdinalIgnoreCase));

        var favoriteQuantities = favorites.Intersect(filtered, StringComparer.OrdinalIgnoreCase).ToList();
        var nonFavoriteQuantities = filtered.Except(favorites, StringComparer.OrdinalIgnoreCase).ToList();

        filteredQuantities = favoriteQuantities.Concat(nonFavoriteQuantities).ToList();

        await LoadQuantityDataAsync(filteredQuantities);
        StateHasChanged();
    }

    private async Task ToggleFavoriteAsync(string quantity)
    {
        if (favorites.Contains(quantity, StringComparer.OrdinalIgnoreCase))
        {
            await FavoritesService.RemoveFavoriteAsync(quantity);
            favorites.Remove(quantity);
        }
        else
        {
            await FavoritesService.AddFavoriteAsync(quantity);
            favorites.Add(quantity);
        }

        await FilterQuantities();
        StateHasChanged();
    }

    private async Task<ConversionResult> ConvertValueAsync(string quantity, double value, string fromUnit, string toUnit)
    {
        return await ConversionService.ConvertAsync(quantity, value, fromUnit, toUnit);
    }
}
